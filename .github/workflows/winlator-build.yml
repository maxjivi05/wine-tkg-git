name: Build Winlator Proton Aarch64

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Manual)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf /usr/lib/jvm
          sudo apt-get clean
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Create Build Script
        run: |
          cat <<'EOF_BUILD' > build_aarch64.sh
          set -e
          export DEBIAN_FRONTEND=noninteractive
          
          echo "Updating and installing dependencies..."
          apt-get update
          apt-get install -y git build-essential bison flex fontforge gettext \
            libasound2-dev libpulse-dev libdbus-1-dev libfontconfig1-dev \
            libgnutls28-dev libpng-dev libxml2-dev libxslt1-dev libxcursor-dev \
            libxcomposite-dev libxi-dev libxinerama-dev libxrandr-dev \
            libsdl2-dev libvulkan-dev libvkd3d-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libudev-dev libusb-1.0-dev libv4l-dev libopenal-dev \
            liblcms2-dev libcups2-dev libgphoto2-dev libsane-dev \
            libkrb5-dev libldap2-dev samba-dev ocl-icd-opencl-dev \
            libpcap-dev python3-pefile python3-tk fonttools \
            ccache jq zstd xvfb kmod xz-utils
          
          # TkG Configuration
          echo "Configuring wine-tkg..."
          sed -i 's/_LOCAL_PRESET=""/_LOCAL_PRESET="valve-exp-bleeding"/' proton-tkg/proton-tkg.cfg
          sed -i 's/_no_autoinstall="false"/_no_autoinstall="true"/' proton-tkg/proton-tkg.cfg
          sed -i 's/_nomakepkg_dependency_autoresolver="true"/_nomakepkg_dependency_autoresolver="false"/' proton-tkg/proton-tkg.cfg
          
          echo '_NOLIB32="true"' >> proton-tkg/proton-tkg-profiles/advanced-customization.cfg
          echo '_NOINITIALPROMPT="true"' >> proton-tkg/proton-tkg-profiles/advanced-customization.cfg
          
          echo "_ci_build='true'" > proton-tkg/proton_tkg_token
          echo "_standard_dlopen='true'" >> proton-tkg/proton_tkg_token
          echo "_proton_tkg_path='/work/proton-tkg'" >> proton-tkg/proton_tkg_token
          
          touch proton-tkg/tarplz
          
          # Build
          echo "Starting build (this will take a while under QEMU)..."
          cd proton-tkg
          yes | ./proton-tkg.sh
          
          # Repack for Winlator
          echo "Repacking for Winlator..."
          mkdir -p /work/repack
          TARBALL=$(ls built/*.tar | head -n 1)
          if [ -z "$TARBALL" ]; then 
            echo "Build failed, no tarball found in built/"
            exit 1
          fi
          
          tar -xf "$TARBALL" -C /work/repack/
          DIST_DIR=$(ls -d /work/repack/proton_tkg_* | head -n 1)
          
          if [ -d "$DIST_DIR/files" ]; then
            mv "$DIST_DIR"/files/* /work/repack/
          else
            mv "$DIST_DIR"/* /work/repack/
          fi
          rm -rf "$DIST_DIR"
          
          # Create profile.json
          cat <<EOF_JSON > /work/repack/profile.json
          {
            "name": "Proton Bleeding Edge (TkG) Aarch64",
            "type": "wine",
            "version": "bleeding-edge",
            "path": "."
          }
          EOF_JSON
          
          # Generate minimal prefix
          echo "Generating minimal prefix..."
          export WINEPREFIX=/work/repack/prefix_tmp
          export PATH=/work/repack/bin:$PATH
          export LD_LIBRARY_PATH=/work/repack/lib/wine/aarch64-unix:/work/repack/lib64/wine/aarch64-unix:$LD_LIBRARY_PATH
          
          Xvfb :99 -screen 0 1024x768x16 &
          export DISPLAY=:99
          
          wineboot --init || true
          sleep 15
          
          if [ -d "/work/repack/prefix_tmp" ]; then
            cd /work/repack/prefix_tmp
            tar -cJf ../prefix.tar.xz .
            cd /work
            rm -rf /work/repack/prefix_tmp
          else
            echo "Warning: wineboot failed, creating dummy prefix"
            mkdir -p /work/repack/prefix_dummy/drive_c
            cd /work/repack/prefix_dummy
            tar -cJf ../prefix.tar.xz .
            cd /work
            rm -rf /work/repack/prefix_dummy
          fi
          
          # Create final WCP
          cd /work/repack
          tar -cf - bin lib* share profile.json prefix.tar.xz | zstd -19 -o /work/proton-tkg-bleeding-edge-aarch64.wcp
          echo "Final repack complete"
          EOF_BUILD
          chmod +x build_aarch64.sh

      - name: Build in ARM64 Container
        run: |
          docker run --rm --privileged \
            -v $(pwd):/work \
            -w /work \
            --platform linux/arm64 \
            ubuntu:22.04 /bin/bash /work/build_aarch64.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: proton-tkg-winlator-aarch64
          path: proton-tkg-bleeding-edge-aarch64.wcp