name: Build Winlator Compatible Wine

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib \
            bison flex make pkg-config libasound2-dev libpulse-dev libdbus-1-dev \
            libfontconfig1-dev libfreetype6-dev libgnutls28-dev libjpeg-dev \
            libpng-dev libtiff-dev libx11-dev libxcomposite-dev libxcursor-dev \
            libxext-dev libxi-dev libxrandr-dev libxrender-dev libxinerama-dev \
            libxml2-dev libxslt1-dev libxt-dev libxv-dev libxxf86vm-dev \
            libgl1-mesa-dev libglu1-mesa-dev libosmesa6-dev libudev-dev \
            libsdl2-dev libvulkan-dev zstd tar git python3 python3-pip

      - name: Configure Proton-TKG
        working-directory: proton-tkg
        run: |
          # Use the 'valve-exp-bleeding' preset for bleeding edge
          sed -i 's/_LOCAL_PRESET=""/_LOCAL_PRESET="valve-exp-bleeding"/' proton-tkg.cfg
          
          # Match official workflow configuration
          sed -i 's/uninstaller="false"/uninstaller="true"/' proton-tkg.cfg
          sed -i 's/autoinstall="false"/autoinstall="true"/' proton-tkg.cfg
          sed -i 's/_no_container="true"/_no_container="false"/' proton-tkg.sh
          
          # Set CI build flag
          echo '_ci_build="true"' >> proton-tkg.cfg
          
          # Request tarball creation
          touch tarplz
          
          # Ensure script is executable
          chmod +x proton-tkg.sh
          
          # Debug: Show config
          cat proton-tkg.cfg

      - name: Build Proton
        working-directory: proton-tkg
        run: |
          # Create dummy user config to avoid prompts
          mkdir -p ~/.config/frogminer
          touch ~/.config/frogminer/proton-tkg.cfg
          
          # Run the build script with 'yes' to answer prompts
          yes | ./proton-tkg.sh

      - name: Package for Winlator
        run: |
          echo "Packaging..."
          mkdir -p winlator_package
          
          # Find the built tarball in proton-tkg/built/
          TARBALL=$(find proton-tkg/built -name "proton_tkg_*.tar" | sort | tail -n 1)
          
          if [ -z "$TARBALL" ]; then
            echo "Tarball not found in proton-tkg/built!"
            ls -R proton-tkg
            exit 1
          fi
          
          echo "Found tarball at: $TARBALL"
          
          # Extract tarball to package dir
          tar -xvf "$TARBALL" -C winlator_package
          
          # The tarball likely contains a top-level directory (e.g., proton_tkg_x.x). 
          # Winlator .wcp usually expects the structure to be flat or have a specific root.
          # Let's inspect what we extracted.
          echo "Extracted contents:"
          ls -F winlator_package
          
          # If extracted content is a single directory, move its contents up
          if [ $(ls -1 winlator_package | wc -l) -eq 1 ] && [ -d "winlator_package/$(ls -1 winlator_package)" ]; then
            SUBDIR=$(ls -1 winlator_package)
            echo "Moving contents from $SUBDIR to root..."
            mv winlator_package/"$SUBDIR"/* winlator_package/
            rmdir winlator_package/"$SUBDIR"
          fi
          
          # Create profile.json
          cat <<EOF > winlator_package/profile.json
          {
            "name": "Proton-Bleeding-Edge-TKG",
            "type": "wine",
            "path": "."
          }
          EOF
          
          # Create .wcp archive (Zstd compressed tarball)
          cd winlator_package
          tar --zstd -cvf ../proton-bleeding-edge.wcp .
          cd ..
          
          ls -lh proton-bleeding-edge.wcp

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: proton-bleeding-edge-wcp
          path: proton-bleeding-edge.wcp